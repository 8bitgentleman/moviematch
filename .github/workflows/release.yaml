name: release

on:
  push:
    branches: [dev]
    # tags:
    #   - 'v*'

jobs:
  build:
    name: ${{ matrix.kind }} ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60
    strategy:
      matrix:
        include:
          - os: macos-10.15
            kind: build
          - os: windows-2019
            kind: build
          - os: ubuntu-latest
            kind: build
    steps:
      - name: Clone repository
        uses: actions/checkout@v2
      - name: Install Deno
        if: |
          !startsWith(matrix.os, 'windows')
        run: |-
          curl -fsSL https://deno.land/x/install/install.sh | sh
          echo "$HOME/.deno/bin" >> $GITHUB_PATH
      - name: Install Node
        uses: actions/setup-node@v2
        with:
          node-version: "14"
          check-latest: true
      - name: Install Deno (Windows)
        if: startsWith(matrix.os, 'windows')
        run: |-
          curl -fsSL https://deno.land/x/install/install.sh | sh
          echo "$HOME/.deno/bin" >> $env:GITHUB_PATH
      - name: Upgrade Deno to Canary
        run: deno upgrade --canary
      - name: Install esbuild
        run: npm install -g esbuild
      - name: Log versions
        run: |
          deno --version
          node --version
          esbuild --version
      - name: bundle
        run: ./scripts/bundle.sh
        shell: bash
      - name: Print MovieMatch version
        if: startsWith(matrix.os, 'windows')
        run: .\moviematch.exe --version
      - name: Print MovieMatch version
        if: |
          !startsWith(matrix.os, 'windows')
        run: ./moviematch --version
      - name: Upload binary
        uses: actions/upload-artifact@v2
        if: startsWith(matrix.os, 'windows')
        with:
          name: moviematch-windows.exe
          path: moviematch.exe
      - name: Upload binary
        uses: actions/upload-artifact@v2
        if: |
          !startsWith(matrix.os, 'windows')
        with:
          name: moviematch-${{ matrix.os }}
          path: moviematch